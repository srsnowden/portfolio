---

- hosts: palantir

  tasks:
    - name: Install packages
      apt:
        name:
          - nginx
      become: true

    - name: Copy nginx confs
      copy:
        src: /repos/serenity/config/palantir/nginx/
        dest: /etc/nginx/
      become: true
      notify: "restart nginx"

    - name: Copy certificates
      copy:
        src: "{{ item }}"
        dest: "{{ web.cert }}/"
        force: true
      loop:
        - "{{ dist.cert }}/{{ cert.star }}"
        - "{{ dist.cert }}/{{ cert.star_fc }}"
      become: true
      notify: "restart nginx"

    - name: Sync cats site
      ansible.posix.synchronize:
        src: "{{ dist.cats }}"
        dest: "{{ web.cats }}"
      become: true
      notify: "restart nginx"
  
  handlers:
    - name: restart nginx
      systemd:
        name: nginx
      become: true