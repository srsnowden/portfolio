---

- hosts: proxhost

  tasks:
    - name: Switch to free proxmox repository
      apt_repository:
        repo: "{{ item.target }}"
        state: "{{ item.action }}"
      loop:
        - { target: 'deb https://enterprise.proxmox.com/debian/pve bullseye pve-enterprise', action: 'absent'}
        - { target: 'deb http://download.proxmox.com/debian/pve bullseye pve-no-subscription', action: 'present'}
      become: true
        
    - name: Create users
      user:
        name: "{{ item }}"
        append: true
        groups: sudo
      loop:
        - aragorn
        - strider
      become: true

    - name: Enable passwordless sudo
      lineinfile:
        path: /etc/sudoers
        state: present
        regexp: "{{ item.search }}"
        line: "{{ item.replace }}"
      loop:
        - { search: '^%aragorn', replace: '%aragorn ALL=(ALL) NOPASSWD: ALL' }
        - { search: '^%strider', replace: '%strider ALL=(ALL) NOPASSWD: ALL' }
      become: true

    - name: Create key directories
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - '/home/aragorn/.ssh'
        - '/home/strider/.ssh'
      become: true

    - name: Copy local public keys
      copy:
        src: "{{ item.from }}"
        dest: "{{ item.to }}"
      loop:
        - { from: '/home/aragorn/.ssh/authorized_keys', to: '/home/aragorn/.ssh/authorized_keys' }
        - { from: '/home/strider/.ssh/authorized_keys', to: '/home/strider/.ssh/authorized_keys' }
      become: true

    - name: Update sshd_config
      blockinfile:
        path: /etc/ssh/sshd_config
        block: |
          AllowUsers root@localhost root@192.168.10.30
          AllowUsers aragorn@{{ hostvars['tower'].ansible_host }}
          AllowUsers strider@{{ hostvars['laptop'].ansible_host }}
          AllowUsers sybil@{{ hostvars['nexus'].ansible_host }}
      become: true

    - name: Restart sshd
      systemd:
        name: sshd
        state: restarted
      become: true