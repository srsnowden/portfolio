---

- hosts: localhost

  vars:
    crt_path: /home/aragorn/dist/data/keys
    crt_cn: "*.spencers.house"
    crt_name: star.spencers.house
    cloudflare_email: "srsnowden@gmail.com"
    cloudflare_zone: spencers.house
    cloudflare_api: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          38346134663665663138616662346531643235646237306236316337646561356532373066376233
          3032386339643634366161363561623132303531653837630a353865336138366232366464653736
          35633236363065633864646136363666336139643733323636623837663434393039613132316231
          6237616432393765310a646134313137633666613235636364373233663530363932376536386466
          36613333653032633362393832663663656634353563396634323937323263316230663438623634
          3532626534633138386333353531633166353039396161333936

  tasks:
    - name: generate account key
      openssl_privatekey:
        path: "{{ crt_path }}/acme-key.pem"
        size: 4096
      become: true

    - name: generate signing key
      openssl_privatekey:
        path: "{{ crt_path }}/{{ crt_name }}.pem"
        size: 4096
      become: true

    - name: generate csr
      openssl_csr:
        path: "{{ crt_path }}/{{ crt_name }}.csr"
        privatekey_path: "{{ crt_path }}/{{ crt_name }}.pem"
        common_name: "{{ crt_cn }}"
      become: true

    - name: create acme challenge
      acme_certificate:
        acme_version: 2
        terms_agreed: yes
        account_key_src: "{{ crt_path }}/acme-key.pem"
        src: "{{ crt_path }}/{{ crt_name }}.csr"
        cert: "{{ crt_path }}/{{ crt_name }}.crt"
        challenge: dns-01
        acme_directory: https://acme-v02.api.letsencrypt.org/directory
        remaining_days: 10
      register: challenge
      become: true

    - name: create cloudflare TXT record
      cloudflare_dns:
        api_token: "{{ cloudflare_api }}"
        account_email: "{{ cloudflare_email }}"
        zone: "{{ cloudflare_zone }}"
        record: "{{ challenge.challenge_data[crt_cn]['dns-01'].record }}"
        type: TXT
        value: "{{ challenge.challenge_data[crt_cn]['dns-01'].resource_value }}"
        solo: true
        state: present
      when: challenge is changed

    - name: validate acme challenge
      acme_certificate:
        acme_version: 2
        account_key_src: "{{ crt_path }}/acme-key.pem"
        src: "{{ crt_path }}/{{ crt_name }}.csr"
        cert: "{{ crt_path }}/{{ crt_name }}.crt"
        fullchain: "{{ crt_path }}/{{ crt_name }}-fullchain.crt"
        chain: "{{ crt_path }}/{{ crt_name }}-intermediate.crt"
        challenge: dns-01
        acme_directory: https://acme-v02.api.letsencrypt.org/directory
        remaining_days: 10
        data: "{{ challenge }}"
        request_timeout: 30
      when: challenge is changed
      become: true

    - name: delete cloudflare TXT record
      cloudflare_dns:
        account_api_token: "{{ cloudflare_api }}"
        account_email: "{{ cloudflare_email }}"
        zone: "{{ cloudflare_zone }}"
        record: "{{ challenge.challenge_data[crt_cn]['dns-01'].record }}"
        type: TXT
        state: absent
      when: challenge is changed

    - name: remove account key
      openssl_privatekey:
        path: "{{ crt_path }}/acme-key.pem"
        state: absent
      when: challenge is changed
      become: true