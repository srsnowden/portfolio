---

- hosts: localhost

  tasks:
    - name: Mount external drive
      ansible.posix.mount:
        path: /mnt/ark01
        src: LABEL=ark01
        fstype: ext4
        state: mounted
      become: true
 
    - name: Create public share user
      user:
        name: pippin
        shell: /sbin/nologin
        create_home: no
      become: true

    - name: Chown share directories to share user
      file:
        path: "{{ item }}"
        state: directory
        recurse: yes
        owner: pippin
        group: pippin
      loop:
        - /mnt/ark01/share
        - /mnt/ark01/proxstore
        - /mnt/ark01/archive
      become: true

    - name: Create dist
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - "{{ dist.home }}"
        - "{{ dist.cats }}"
        - "{{ dist.cert }}"
      become: true

    - name: Change dist ownership
      file:
        path: "{{ dist.home }}"
        state: directory
        recurse: yes
        owner: aragorn
        group: aragorn
      become: true

    - name: Set cronjob - renew certificate
      cron:
        name: "renew certificate"
        minute: 0
        hour: 4
        day: 1
        month: "*/2"
        job: "/home/aragorn/.local/bin/ansible-playbook /repos/serenity/playbooks/cert.yml"

    - name: Set permissions on ansible ssh key
      file:
        path: "{{ ansible_ssh_private_key_file }}"
        state: touch
        mode: 0600
        modification_time: preserve
        access_time: preserve
      become: true

    - name: Install packages
      apt:
        name: 
         - vlan
         - samba
         - sshpass
      become: true

    - name: Update vlans config - add vlans for mdns repeater
      copy:
        dest: /etc/network/interfaces.d/vlans
        content: |
          auto eth0.20
          iface eth0.20 inet manual
            vlan-raw-device eth0

          auto eth0.30
          iface eth0.30 inet manual
            vlan-raw-device eth0

          auto eth0.40
          iface eth0.40 inet manual
            vlan-raw-device eth0
      become: true

    - name: Update dhcpcd config - add static addresses
      blockinfile:
        path: /etc/dhcpcd.conf
        block: |
          interface eth0
          static ip_address=192.168.10.20/24
          static routers=192.168.10.1
          static domain_name_servers=192.168.10.100

          interface eth0.20
          static ip_address=192.168.20.5/24
          static routers=192.168.20.1
          static domain_name_servers=192.168.10.100

          interface eth0.30
          static ip_address=192.168.30.5/24
          static routers=192.168.30.1
          static domain_name_servers=192.168.10.100

          interface eth0.40
          static ip_address=192.168.40.5/24
          static routers=192.168.40.1
          static domain_name_servers=192.168.10.100
      become: true

    - name: Create samba user - public share
      shell: "smbpasswd -n -a pippin"
      become: true

    - name: Update samba config - global settings
      blockinfile:
        path: /etc/samba/smb.conf
        insertafter: '\[global\]'
        marker: "# {mark} ANSIBLE GLOBAL CONFIG"
        block: |
         null passwords = yes
         interfaces = eth0
         bind interfaces only = yes
      notify: "restart samba"
      become: true

    - name: Update samba config - share settings
      blockinfile:
        path: /etc/samba/smb.conf
        marker: "# {mark} ANSIBLE SHARE CONFIG"
        block: |
          [share]
              path = /mnt/ark01/share
              writable = yes
              printable = no
              public = yes
              create mask = 0777
              directory mask = 0777
              force user = pippin
              force group = pippin

          [archive]
              path = /mnt/ark01/archive
              writable = yes
              printable = no
              public = yes
              create mask = 0777
              directory mask = 0777
              force user = pippin
              force group = pippin

          [backups]
              path = /mnt/ark01/proxstore/backups
              writable = yes
              printable = no
              public = yes
              create mask = 0777
              directory mask = 0777
              force user = pippin
              force group = pippin

          [templates]
              path = /mnt/ark01/proxstore/templates
              writable = yes
              printable = no
              public = yes
              create mask = 0777
              directory mask = 0777
              force user = pippin
              force group = pippin
      notify: "restart samba"
      become: true

    - name: Update avahi config - enable mdns reflector
      lineinfile:
        path: /etc/avahi/avahi-daemon.conf
        regexp: "{{ item }}"
        line: enable-reflector=yes
      notify: "restart avahi"
      loop:
       - '^\#enable-reflector=*'
       - '^enable-reflector=*'
      become: true

  handlers:
    - name: restart samba
      systemd:
        state: restarted
        name: smbd
      become: true

    - name: restart avahi
      systemd:
        state: restarted
        name: avahi-daemon
      become: true