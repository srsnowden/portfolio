---

- hosts: localhost

  gather_facts: no

  vars_prompt:
    - name: host_ip
      prompt: Enter host ip
      private: false

    - name: uname_in
      prompt: Enter user name
      private: false

    - name: upass_in
      prompt: Enter root account password
      private: true

  tasks:
    - add_host:
        name: "{{ host_ip }}"
        username: "{{ uname_in }}"
        userpass: "{{ upass_in }}"
        groups: target_host

- hosts: target_host

  vars:
    ansible_user: "{{ username }}"
    ansible_password: "{{ userpass }}"

  tasks:   
    - name: Install sudo
      apt:
        name: sudo

    - name: Create ansible user
      user:
        name: sybil
        append: true
        groups: sudo

    - name: Enable passwordless sudo
      lineinfile:
        path: /etc/sudoers
        state: present
        regexp: '^%sybil'
        line: '%sybil ALL=(ALL) NOPASSWD: ALL'

    - name: Create key directory for ansible user
      file:
        path: /home/sybil/.ssh
        state: directory

    - name: Add ansible user public key
      ansible.posix.authorized_key:
        user: sybil
        state: present
        key: https://github.com/srsnowden.keys